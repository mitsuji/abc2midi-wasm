<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>raw2wav</title>
    <!-- script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js"></script -->
  </head>
  <body>
    <form>
      <button type="button" id="buttonRun">run</button>
    </form>
    <script type="module">
      import { FFmpeg } from "/@ffmpeg/ffmpeg/dist/esm/index.js";
      let ffmpeg = null;

      const transcode = async (rawFilename,wavFilename) => {
        if (ffmpeg === null) {
          ffmpeg = new FFmpeg();
          ffmpeg.on("log", ({ message }) => {
            console.log(message);
          })
          ffmpeg.on("progress", ({ progress, time }) => {
            let message = `${progress * 100} %, time: ${time / 1000000} s`;
            console.log(message);
          });
          await ffmpeg.load({
            coreURL: "/@ffmpeg/core/dist/esm/ffmpeg-core.js",
          });
        }
        await ffmpeg.writeFile(rawFilename, await fetchFile(rawFilename));
        console.log('Start transcoding');
        console.time('exec');
        await ffmpeg.exec(["-f","s16le","-ar","44.1k","-ac","2","-i",rawFilename,wavFilename]);
        console.timeEnd('exec');
        console.log('Complete transcoding');
        const dataWav = await ffmpeg.readFile(wavFilename);
        downloadBlob(dataWav, wavFilename, 'audio/wav');
      }

      let buttonRun = document.querySelector("#buttonRun");
      buttonRun.onclick = async (e) => {
          await transcode("kaerunouta.raw","kaerunouta.wav");
      };

      async function fetchFile(url) {
          let res = await fetch(url);
          let blob = await res.blob();
          let buff = await blob.arrayBuffer();
          let data = new Uint8Array(buff);
          return data;
      }
      
      function downloadBlob (data, filename, mimeType) {
        let blob = new Blob([data], {type: mimeType});
        let url = window.URL.createObjectURL(blob);
        let downloadURL = function(url) {
          let a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.style = 'display: none';
          a.click();
          a.remove();
        };
        downloadURL(url);
        setTimeout(function() {
        return window.URL.revokeObjectURL(url);
        }, 1000);
      }
      
    </script>
  </body>
</html>
