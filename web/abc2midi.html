<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>abc2midi-wasm</title>
    <script type="text/javascript" src="abc2midi.js"></script>
  </head>
  <body>
    <form>
      <button type="button" id="buttonRun">run</button>
    </form>
    <script type='module'>
      let abc2midi = await createAbc2Midi({noInitialRun: true});
      let buttonRun = document.querySelector("#buttonRun");
      buttonRun.onclick = async (e) => {
          let abcFilename = "kaerunouta.abc";
          let midiFilename = "kaerunouta.midi";
          await writeFile(abcFilename,abcFilename);
          abc2midi.callMain([abcFilename, "-o", midiFilename]);
          let dataMidi = abc2midi.FS.readFile(midiFilename);
          downloadBlob(dataMidi, midiFilename, 'audio/midi');
      };

      async function writeFile(url, path) {
          let res = await fetch(url);
          let blob = await res.blob();
          let buff = await blob.arrayBuffer();
          let data = new Uint8Array(buff);
          abc2midi.FS.writeFile(path,data);
      }

      function downloadBlob (data, filename, mimeType) {
        let blob = new Blob([data], {type: mimeType});
        let url = window.URL.createObjectURL(blob);
        let downloadURL = function(url) {
          let a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.style = 'display: none';
          a.click();
          a.remove();
        };
        downloadURL(url);
        setTimeout(function() {
        return window.URL.revokeObjectURL(url);
        }, 1000);
      }

    </script>
  </body>
</html>
